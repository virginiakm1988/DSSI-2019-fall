---
title: "AS05"
author: "Virginia Chen"
date: "2019/10/30"
output:
  html_document:
    css: style.css
    highlight: tango
    number_sections: yes
    theme: readable
    toc: yes
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(httr)
library(RCurl)
library(XML)
library(lubridate)
library(rjson)
options(encoding = "utf8")
options(stringsAsFactors = F)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r initialize}
titles<-list()
id <- list()
publishat<-list()
links<-list()
all.datas<-data.frame()
```

## Including Plots

You can also embed plots, for example:

```{r newslink}
  for (news_page in 1:10){
    url <- paste0("https://news.cnyes.com/api/v3/news/category/headline?limit=30&startAt=1571414400&endAt=1572364799&page=",news_page)
    res<- GET(url) %>% content("text") %>% fromJSON()
    df <- res$items$data
    length(df)
    for (i in 1:length(df)){
    titles<-append(titles,df[][[i]]$title)
    id <- append(id,df[][[i]]$newsId)
    publishat<-append(publishat,df[][[i]]$publishAt)
    links <-append(links, paste0("https://news.cnyes.com/news/id/",df[][[i]]$newsId,"?exp=a"))
    }
    names(titles)="titles"
    names(id)="id"
    title.id<-cbind(titles,id,publishat,links)
    datas<-data.frame(title.id)
    datas.name<-data.frame(title.id)
    rownames(datas) <- NULL
    all.datas<-bind_rows(all.datas,datas)
  }
#all.datas%>%view()
temp.data <- all.datas%>%filter(!duplicated(all.datas$titles))
#save(temp.data,file="newslink.rda")


```

```{r plot}
time = c()
for( i in 1:length(temp.data$publishat)){
  time<-append(time, as_datetime(temp.data$publishat[[i]]))
}
week <- strftime(time,format="%W")
temp.data%>% mutate(week = as.numeric(strftime(time,format="%W")))
temp.data$week <- week
#temp.data%>%view()

ggplot(temp.data, aes(time)) + geom_histogram(fill = "#4287f5")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
```{r news}
all.news<-data.frame()
news<-data.frame()
for (i in 1:length(temp.data$titles)){
  #標題、內文、發佈時間、相關個股
  url<-(temp.data$links[[i]])
  #url<-"https://news.cnyes.com/news/id/4402323?exp=a"
  res<- GET(url)
  doc <-read_html(url)
  title <- html_nodes(doc,"h1")%>%html_text()
  content<- html_nodes(doc,"p")%>%html_text()
  time <- html_node(doc,'time, p')%>%html_text()
  relative.stocks <- html_nodes(doc,"._1FfA")%>%html_text()
  news<-data.frame(title,time)
  news$content<-list(c(content))
  news$relative.stocks<-list(c(relative.stocks))
  relative.stocks
  all.news<-bind_rows(all.news,news)
}
#all.news%>%view()
#save(all.news,file="news.rda")

```
